---
sidebar_position: 2
slug: woice_v1.x
---

:::note 修订记录

**2021-12-9** 燕卫博[WindForest@yeah.net] 创建V1.x初始版本。

:::

<br/>

:::info 相关信息

Woice（Wind-Voice，恒音·风鸣）协议为 **一种基于TCP的会话层消息传输协议** ，由 **Turix-CEL联合实验室** 设计。

本协议是基于 **Loice V1.x设计原型** 重新设计的。

当前版本：V1.x 设计原型。仅用于 **原理讨论** 和 **思路开拓**，暂不提供代码实现。

:::

<br/>

:::caution 注意事项

- 设计原型用于原理说明，在具体应用场景下使用时可能需要重新评估或修订。

- 本协议原型 **完全开放** ，您拥有全盘抄袭和任意修改的能力。但是我们仍希望您能够在以下行为中 **任选其一** 以支持创建者的工作：
    1. 与版本创建者取得联系，为其介绍一下即将使用本协议的业务或项目；
    2. 在相关程序和文档中标明出处或引用本网页作为参考；
    3. 在参与者名单中增加版本创建者的名字。

:::

<br/>

## 1 介绍

One connection, then everything. 一条连接，而后万事具备。

<center>

<img src="/img/Woice协议层示意.png" alt="Woice协议层示意"  />

</center>

### 1.1 起源与简介

Woice通信协议是为低负载和低吞吐量嵌入式设备设计的一种依赖TCP传输层协议的 **会话层** 消息传输协议。尽管协议本身支持一对多或多对一的交互访问，但它在一对一的通信需求中更为适合。

Woice协议为一条TCP连接抽象出多条消息通道，并管理这些通道内数据的传输过程。在Woice协议之上，用户还需要使用（或设计）基于Woice的表示层或应用层协议以满足具体的业务需求。本文描述了Woice协议的协议模型设计、通信角色定义、协议帧规定和其它协议特性。

Woice协议在Loice V1.x设计原型上做出了以下改进：

- 将本机识别信息（如通信双方ID等）从协议字段携带改为基于字符串的信息简报形式；
- Woice可被实现为一种底层库，不直接对接应用层业务；
- Woice中不再区分“指令帧”和“数据帧”，对于本协议而言，仅有消息传递的最基本单元即“协议帧”；
- 对于通信双方而言，传输通道是对等的。这意味着在Woice协议层面，一条消息通道中不同方向的数据是相互独立的，然而这一点仍然取决于上层协议的规定。

### 1.2 协议限制

Woice协议具有以下限制：

1. 由于 **默认** 情况下Woice协议实例需要同时支持主机和从机功能，这将占用指定的TCP监听端口，因此一个设备仅能拥有一个Woice协议实例。通过关闭主机/从机功能或指定不同的监听端口可使设备运行多个Woice协议层实例；
2. Woice协议中，从一条TCP连接中抽象出的传输通道数量是有限的，最大为 **255×65536=16,711,680** 个；
3. Woice按协议帧发送消息，数据传输的效率主要由网络质量和系统性能决定。

### 1.3 依赖和协议适用

Woice协议基于TCP传输层协议，依赖TCP的可靠连接和流式传输等特性，理论上只要通信双方能够正常建立TCP连接，就能够使用Woice协议。考虑到TCP传输依然有出现错误的可能，Woice在协议帧中增加了必要的校验字段以保证消息的正确性。

Woice的传输基于无符号字节流，因此通信双方必须事先规定传输时使用的字节序，事实上，只要双方设备使用的架构相同，通常不需要考虑字节序问题。Woice协议默认采用 **小端模式** 进行传输，本文也以小端模式进行叙述。

<br/>

## 2 Woice协议

### 2.1 通信角色和协议模型

在使用Woice协议的通信系统中，两设备中作为TCP客户端发起连接的一方称为 **Woice主机**，作为TCP服务端接受连接的一方称为 **Woice从机**。对于一条特定的连接，通信双方的角色是固定的。

在默认情况下，一个设备既可以作为主机主动发起连接，也可以作为从机等待连接，但设备可以主动选择是否停用主机功能或从机功能中的一种。通信双方的TCP连接一旦建立，除信息简报交互顺序和KAP应答方向根据主机或从机的身份而异之外，通信过程本身是对等的。

Woice从机负责建立TCP服务端，默认绑定在 **1103** 端口，一条TCP连接即一个 **Woice会话** 。

### 2.2 协议帧

遵循Woice协议的一条完整的消息称为一个**协议帧**，每协议帧包含一个定长的消息首部和可变长的消息体。

#### 2.2.1 消息首部

为了在TCP的流式传输中获取一帧完整的协议帧，Woice协议规定了一个定长的消息首部作为每协议帧的起始，所有传输的消息必须至少包含这个首部，以便对端的识别和处理。

<center>

```
+-----byte 0----|-----byte 1----|-----byte 2----|-----byte 3----+
|7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0|
+---------------+---------------+---------------+---------------+
|                       Head(14-CF-92-5A)                       |
+---------------+---------------+---------------+---------------+
|                       Head(A0-CA-00-FF)                       |
+---------------+---------------+---------------+---------------+
|                 32-bit Message Timestamp(00H)                 |
+---------------+---------------+---------------+---------------+
|              Reserved For 64-bit Timestamp(00H)               |
+---------------+---------------+---------------+---------------+
| Message Type  |  Channel Type |        Channel Index          |
+---------------+---------------+---------------+---------------+
|               Payload Length(All Message Body)                |
+---------------+---------------+---------------+---------------+
|    Channel Sequence Number    |  Message Header Check(16-bit) |
+---------------+---------------+---------------+---------------+
```

</center>

Woice协议消息首部（固定为 **28** 个字节）：

- 使用 **8** 个固定字节（0xFF00CAA05A92CF14）作为 **帧头** ，以便通信双方从连续的字节流中获取到消息的起始位置；
- 使用 **4** （ **+4** 扩展）字节长度的 **时间戳** 信息可在通信双方具有同步时钟的情况下供双方测试网络延迟、推测消息处理性能、消息新旧校验等之用；
- 使用 **1** 字节的 **消息类型** 字段用于指示当前首部的消息类型。根据消息类型，协议帧可分为 **（普通）协议帧** 和 **内部协议帧** 两种；
- 使用 **1** 字节的 **通道类型** 和 **2** 字节的 **通道索引（通道号）** 字段的组合标识每条抽象出的消息通道，详见 **2.3 消息通道** 章节；
- 使用 **4** 字节的 **荷载长度** 字段用于指示后续消息体的总长度，为接收方接收变长消息体提供申请缓冲区的所需长度信息；
- 使用 **2** 字节长度的 **通道序列号** 供源设备指示当前协议帧在所在消息通道中的 **单向发送** 顺序，同时在回应时起到协议帧标识作用，被协议帧重传机制使用；
- 使用 **2** 字节的 **首部验证** 字段用于确保首部信息的正确性，尤其是其中荷载长度的正确性。

其中，消息类型主要包括发送方相关、接收方相关和心跳包相关3个部分，具体如下（使用C语言枚举定义）：

```c
// ----------------------------------------
// 00000000 b 保留
// 0001XXXX b 消息发送
// 0002XXXX b 消息回应
// 1100XXXX b 协议层KAP
// 其它：保留
// ----------------------------------------
typedef enum message_type
{
    MSG_TYPE_RESERVED       = 0,
    // ----------------------------------------
    // 消息发送
    // ----------------------------------------
    MSG_TYPE_NORMAL         = 0x10, /* 消息需要应答 */
    MSG_TYPE_NOREPLY        = 0x11, /* 消息无需应答 */
    // ----------------------------------------
    // 消息应答
    // ----------------------------------------
    MSG_REPLY_OK            = 0x20, /* 消息被成功接收 */
    MSG_REPLY_OUTDATE       = 0x21, /* 消息是过时的 */
    MSG_REPLY_TOO_LONG      = 0x22, /* 消息超出接收方最大长度限制 */
    MSG_REPLY_TOO_SHORT     = 0x23, /* 消息小于协议最小长度限制 */
    MSG_REPLY_WRONG_CHECK   = 0x24, /* 消息体校验失败 */
    MSG_REPLY_UNREGISTERED  = 0x25, /* 消息所发往的通道未注册 */
    MSG_REPLY_UNVERIFIED    = 0x26, /* 暂未确认连接口令，消息将被丢弃 */
    MSG_REPLY_CHANNEL_PAUSE = 0x27, /* 当前通道暂停接收功能 */
    MSG_REPLY_WRONG_CHANNEL = 0x28, /* 当前消息指定的目标消息通道错误，消息将被丢弃 */
    // ----------------------------------------
    // 心跳包相关
    // NOTE:Woice协议层对心跳包的回应是强制的
    // ----------------------------------------
    KAP_TYPE_NORMAL         = 0xC3, /* 探测对端是否存在 */
    KAP_REPLY_OK            = 0xC4, /* 协议层KAP存在性回复 */
}ENUM_MESSAGE_TYPE;
```

有关消息应答的说明详见 **2.4 消息应答** 章节；有关心跳包相关的说明详见 **2.6 协议层KAP** 章节。

对于消息首部包含的字段有以下解释或说明：

- 时间戳

    时间戳字段可由用户设计或使用系统时间戳，由于32位时间戳存在2038年问题，因此消息首部保留对64位时间戳的支持。**当通信双方不启用时间戳时，该字段必须设置为0**。

- 通道序列号范围

    通道序列号字段从 **1** 开始计数，溢出后重新从 **1** 开始，为协议帧重传机制保留。**当通道序列号为0时，表示禁用序列号指示**（即放弃协议帧重传）。通道序列号 **与通信方向相关**，各方独立维护本地通道序列号发送计数。

    有关通道序列号的说明详见 **2.3 消息通道** 章节。

    > 注：通道序列号仅用于Woice协议层，不向上层提供

- 荷载长度

    荷载长度字段用于指示在消息首部之后还有多少字节的变长消息。**当一条消息仅有首部时，荷载长度字段必须设置为0**。

- 消息首部校验

    首部校验可使用多种校验方式，只要通信双方支持并遵守即可，默认使用 **16-bit和校验** 。

#### 2.2.2 消息体

当Woice协议帧携带有效荷载时，消息体为这些变长数据提供封装。

<center>

```
+-----byte 0----|-----byte 1----|-----byte 2----|-----byte 3----+
|7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0|
+---------------+---------------+---------------+---------------+
|   Message Body Check(16-bit)  |         Reserved(00H)         |
+---------------+---------------+---------------+---------------+
|                    Variable Length Data                       |
|                              ...                              |
+---------------+---------------+---------------+---------------+
```

</center>

消息体拥有独立的 **消息体校验** 字段，该校验可使用多种校验方式，只要通信双方支持并遵守即可，默认使用 **16-bit和校验** 。

协议帧最小长度为 **4** 字节，最大长度取决于接收端设置（ **≥4字节**）；当协议帧中荷载长度字段设置为 **0** 时，该协议帧无消息体部分。

### 2.3 消息通道

Woice协议的每个协议帧的消息首部均有 **通道类型** 和 **通道索引** 字段，每个 **通道类型-通道索引** 的组合构成了一条抽象的 **消息传输通道**，一个Woice会话中的多个消息通道优先级相同，通过共享发送队列复用一条TCP连接。当通信双方在消息通道中传递数据时，分属于各通道协议帧的 **通道序列号** 字段应顺序递增。

Woice协议将 **0-X** 的消息通道保留为协议内部使用，所有发往这些通道的数据将被协议层内部处理，上层协议或应用程序在基于Woice协议通信时，应避免使用这些消息通道。内部保留通道的预分配和作用如下表所示：

<center>

| 消息通道 |  预分配作用  |        数据传输格式         |
| :------: | :----------: | :-------------------------: |
|   0-0    |   信息简报   | 详见 **2.5 信息简报** 章节  |
|   0-1    |  协议层KAP   | 详见 **2.6 协议层KAP** 章节 |
|   0-2    | 连接口令相关 | 详见 **4.2 连接口令** 章节  |
|   其它   |     保留     |              -              |

</center>

特别地，如果因为协议层错误、传输错误或其它异常导致普通消息通道中出现内部协议帧或内部消息通道中出现普通协议帧的情况，这些协议帧将被丢弃而不向后级逻辑转发，该协议帧的回应中 **消息类型** 字段将被设置为 **MSG_REPLY_WRONG_CHANNEL** 。

### 2.4 消息应答

:::caution 注意事项

本章节所述消息应答不适用于协议层内部（即 **0-X** 消息通道）信息交互过程。协议层内部信息交互详见相关章节如 **2.5 信息简报** 和 **2.6 协议层KAP** 等。

:::

消息应答用于向对端报告通信过程中协议帧的接收和校验等情况。应答协议帧仅包含消息首部，没有附加的消息体，表现为首部中的 **荷载长度** 字段为 **0** 。

对于首部消息类型字段为 **MSG_TYPE_NORMAL** 的协议帧，消息接收方支持以下回应内容（可同时见于 **2.2.1 消息首部** 章节）；而对于首部消息类型字段为 **MSG_TYPE_NOREPLY** 的协议帧，消息接收方不需要向对端发送任何应答（即使该消息的接收出现错误）。

<center>

|        消息应答         |                   应答说明                   |           校验位置           |
| :---------------------: | :------------------------------------------: | :--------------------------: |
|      MSG_REPLY_OK       |                消息被成功接收                |           ALL PASS           |
|    MSG_REPLY_OUTDATE    |                 消息是过时的                 |          时间戳字段          |
|   MSG_REPLY_TOO_LONG    |          消息超出接收方最大长度限制          |         荷载长度字段         |
|   MSG_REPLY_TOO_SHORT   |     消息小于协议最小长度限制（＜4字节）      |         荷载长度字段         |
|  MSG_REPLY_WRONG_CHECK  |                消息体校验失败                |        消息体校验字段        |
| MSG_REPLY_UNREGISTERED  |            消息所发往的通道未注册            |      通道类型和通道索引      |
|  MSG_REPLY_UNVERIFIED   |        暂未确认连接口令，消息将被丢弃        |       信息简报交互状态       |
| MSG_REPLY_CHANNEL_PAUSE |     当前通道暂停接收功能，丢弃所有协议帧     |           通道属性           |
| MSG_REPLY_WRONG_CHANNEL | 当前消息指定的目标消息通道错误，消息将被丢弃 | 消息类型、通道类型和通道索引 |

</center>

在以下情况下，消息接收方将直接丢弃协议帧而不产生回应：

- 消息首部的帧头错误；
- 消息首部校验失败。

此时，消息发送方可通过如超时机制、下一协议帧回应的时间戳和序列号等信息判断是否出现协议帧丢失。除此之外，Woice消息发送方可根据上述应答判断消息是否被正确送达。

### 2.5 信息简报

信息简报用于向通信对方提供本机设备必要的描述信息，以供双方识别和记录，同时可作为部分扩展功能的支撑。

当通信双方的TCP连接建立后，**Woice主机** 首先从 **0-0** 内部消息通道向对端发送自己的信息简报，**Woice从机** 收到来自主机的消息简报后，立即回复应答报文，然后构建并发送己方信息简报。在通信畅通的情况下，双方信息简报的交互仅进行 **1** 次，交互完成前双方 **暂停KAP协议帧收发** 且消息通道保持 **暂停接收** 状态。

特别地，若信息简报协议帧出现错误，则检测到错误的一方应主动关闭连接。

信息简报的具体内容以 **字符串** 形式随消息体发送，包含以下部分：

1. 本机设备信息；
2. 当前Woice协议层版本和限制信息；
3. 当前会话信息。

信息简报按行组织，每行格式如下所示。

```
项:字符串
item_1:string_1
item_2:string_2
...
```

信息简报中各项定义如下，对于Woice主机和Woice从机，它们中的某些不是必须的。

<center>

|      项       |             值              |                             说明                             |
| :-----------: | :-------------------------: | :----------------------------------------------------------: |
|      id       | e.g. "BC4699-BBFEC5-1-1213" |            可用于自定义的设备ID或其它程序标识信息            |
| woice_version |      "V1.x Prototype"       |             提供woice版本和实现信息供兼容或适配              |
| session_role  |  "master"、"slave"、"none"  |                   当前会话在该连接中的角色                   |
|  max_session  |            "10"             |                   当前程序支持的最大会话数                   |
| exist_session |             "2"             |                当前已存在的会话数（包含自身）                |
|    status     |      "OK"、"Disabled"       |       用于指示当前程序/设备是否使能通信或做好通信准备        |
| ipv4_support  |         "YES"、"NO"         | 用于指示当前程序/设备是否支持IPv4连接，详见 **4.1 IPv6支持** 章节 |
| ipv6_support  |         "YES"、"NO"         | 用于指示当前程序/设备是否支持IPv6连接，详见 **4.1 IPv6支持** 章节 |
| conn_password |    "Enabled"、"Disabled"    |   用于指示当前连接是否需要口令，详见 **4.2 连接口令** 章节   |
|      ...      |             ...             |                             ...                              |

</center>

以下为通信双方发送信息简报内容的示例：

- Woice主机

    ```
    id:BC4699-BBFEC5-1-1213-2
    woice_version:V1.0 Test
    session_role:master
    ```

- Woice从机

    ```
    id:BC4699-BBFEC5-1-1213-1
    woice_version:V1.0 Beta
    session_role:slave
    max_session:5
    exist_session:1
    status:OK
    ipv4_support:YES
    ipv6_support:NO
    conn_password:Disabled
    ```

在以下情况发生时，新连接将在 **完成信息简报交互后** 被Woice（主机或从机方的）协议层主动关闭，此时信息简报将提供关闭的原因：

1. 通信双方的Woice版本不兼容；
2. Woice会话的角色不正确；
3. 当前Woice实例达到最大连接数限制；
4. 当前Woice实例因故未做好消息处理准备；
5. 连接口令错误（详见 **4.2 连接口令** 章节）；
5. 信息简报项目缺失。

### 2.6 协议层KAP

考虑到TCP在长连接时无法获得对端存活状态，Woice定义了协议层KAP消息（以下简称KAP）。KAP仅包含消息首部，没有附加的消息体，表现为首部中 **荷载长度** 字段为 **0** 。KAP使用 **0-1** 内部保留的消息通道。

对于一个已经建立并完成身份验证（详见 **4.2 连接口令** 章节）的Woice会话，KAP总是由 **Woice主机** 定时发起，由 **Woice从机** 应答，KAP消息的往复过程即会话的心跳。当收到来自 **Woice主机** 首部消息类型字段为 **KAP_TYPE_NORMAL** 的协议帧时，**Woice从机** 在校验其正确性后构建并发送首部消息类型字段为 **KAP_REPLY_OK** 的KAP应答。

Woice通信双方对KAP的处理策略如下：

<center>

|           项           |                             说明                             |
| :--------------------: | :----------------------------------------------------------: |
| Woice主机的KAP发送策略 | 一定时间范围内，本机未发送包括回应在内的任何协议帧到 **Woice从机**，则应立即构建并发送一帧KAP |
| Woice主机的KAP超时策略 | 一定时间范围内，本机未从 **Woice从机** 收到包括KAP在内的任何协议帧的回应，则应将会话标定为失效并执行清理过程 |
| Woice从机的KAP处理策略 | 当收到来自 **Woice主机** 的KAP时，构建对应的回应协议帧并追加到发送队列 |
| Woice从机的KAP超时策略 | 一定时间范围内，本机未从 **Woice主机** 收到包括KAP在内的任何 **有效** 协议帧 |

</center>

在以下情况下，**Woice从机** 将直接丢弃该KAP而不产生回应：

- 消息首部的帧头错误；
- 消息首部校验失败。

上述策略中，消息通道中传输的数据在一定程度上充当了KAP，这是为了在双方有大量数据传输时节约带宽和处理器资源。当网络质量较差导致消息通道中的数据在发送方 **持续** 堆积时，KAP机制将使得协议层主动断开连接。

<br/>

## 3 实现要点

本章所述部分事项仅供参考。

### 3.1 连接管理相关

连接管理是Woice实例的核心，向外为已建立的TCP连接创建Woice会话实例，向内调度各Woice会话。连接管理持有所在Woice实例的全局信息，包括TCP服务器实例、会话数量、实例ID等，并负责提供构建信息简报所需用的配置字段。

连接管理具有以下 **职能** ：

1. 保存并维护会话实例列表，并将连接描述符和会话ID做绑定；
2. 轮询各会话的发送队列并执行协议帧发送；
3. 监视会话实例列表中各会话描述符，当接收到数据时，根据会话状态为其保存协议帧数据；
4. 为上层协议或应用提供API接口；
5. 输出运行日志；
6. 其它必要的功能。

连接管理可提供以下 **API** ：

- **Woice_Create_Instance** (*实例指针，实例配置结构体)

    创建一个连接管理实例（Woice实例）并运行。

    成功返回0，实例指针指向创建的实例，失败返回错误码（负值）。

- **Woice_Destroy_Instance** (*实例指针)

    结束一个连接管理实例（Woice实例）的运行并释放其所占资源。实例持有的会话将同时被关闭。

    成功返回0，实例指针被清空（赋值为NULL），失败返回错误码（负值）。

- **Woice_Get_Info** (*实例信息结构体指针)

    获取实例信息，包括实例配置和运行状态等。

    成功返回0，失败返回错误码（负值）。

- **Woice_Get_Session_Info** (实例指针，会话ID)

    获取会话信息，包括会话状态和流量统计等。

- **Woice_Session_Create** (实例指针，对端地址表示结构体，连接配置和选项，超时时间)

    创建一个会话，向对端Woice从机发起连接。

    成功返回0，失败返回错误码（负值）。

- **Woice_Session_Send** (实例指针，会话ID，通道，消息地址，消息长度，同步/异步选项，超时时间)

    向指定会话的指定通道发送消息，调用会话实例的 **msg_send** 方法，返回值与该方法同。

- **Woice_Session_Cancel** (实例指针，会话ID，协议帧ID，超时时间)

    从指定会话的发送队列撤销消息，调用会话实例的 **msg_cancel** 方法，返回值与该方法同。

- **Woice_Session_Delete** (实例指针，会话ID)

    删除指定会话，调用会话实例的 **delete** 方法，返回值与该方法同。

- **Woice_Channel_Enable** (实例指针，会话ID，通道)

    使能某会话的指定通道，当通道被注册时有效，仅适用于普通消息通道。

    成功返回0，失败返回错误码（负值）。

- **Woice_Channel_Disable** (实例指针，会话ID，通道)

    禁用某会话的指定通道，当通道被注册时有效，仅适用于普通消息通道。

    成功返回0，失败返回错误码（负值）。

连接管理可提供以下 **回调** ：

- **msg_recv_callback** ()

    当某个会话实例完成一个协议帧的接收和校验后，它将查找通道注册表中的记录，使用对应的接收回调函数完成协议帧转发。

- **event_proc_callbacks**

    事件处理回调仅为上层协议或应用提供通知，Woice协议层应提供默认的内部处理措施，具体包括：

    - **woice_notice_callback** ()

        来自Woice协议层本身的信息，如连接的建立（会话的创建）或断开（会话的销毁）、内部错误、连接达到上限等。

    - **woice_send_event_callback** ()

        发送过程中的事件（非致命），如发送队列已满等。

    - **woice_send_error_callback** ()

        发送过程中出现的错误，如系统调用失败等。

    - **woice_session_state_callback** ()

        会话状态通知，如会话或消息通道状态变更等。

    - **woice_recv_event_callback** ()

        接收过程中的事件（非致命），如收到错误的协议帧、连接断开等。

    - **woice_recv_error_callback** ()

        接收过程中出现的错误，如系统调用失败等。

### 3.2 会话相关

会话是对TCP连接的封装，是连接管理调度的实体，可以实现为一个结构（如C）或一个对象（如C++）。一个会话包含抽象出来的多条消息通道，并负责记录这些消息通道的状态。

Woice会话实例在连接建立时被创建，在连接断开时被删除。除其它必要配置项或变量外，Woice会话实例应当至少保存以下 **内容** ：

1. 连接描述符

2. 会话ID

    会话ID由Woice协议层分配，用于标识不同的会话。

3. 会话状态

    会话状态用于指示当前会话的可操作性，主要包括以下几种可选项：

    ```c
    typedef enum woice_session_state
    {
        SESSION_STAT_INIT = 0,
        SESSION_STAT_OK,
        SESSION_STAT_DISABLED,
        SESSION_STAT_TO_BE_DELETED
    }ENUM_WOICE_SESSION_STATE;
    ```

4. 协议帧接收状态

    该标志用于记录当前协议帧接收状态，

    ```c
    typedef enum woice_protocol_frame_state
    {
        PROTO_FRAME_STAT_INIT = 0,
        PROTO_FRAME_STAT_STANDBY,
        PROTO_FRAME_STAT_GOTHEAD1,
        PROTO_FRAME_STAT_GOTHEAD2,
        PROTO_FRAME_STAT_GOTHEAD3,
        PROTO_FRAME_STAT_GOTHEAD4,
        PROTO_FRAME_STAT_GOTHEAD5,
        PROTO_FRAME_STAT_GOTHEAD6,
        PROTO_FRAME_STAT_GOTHEAD7,
        PROTO_FRAME_STAT_GOTHEAD8,
        PROTO_FRAME_STAT_MSG_HEAD_PASS, /* 消息首部接收并校验完成 */
        PROTO_FRAME_STAT_MSG_BODY_PASS, /* 消息体接收并校验完成 */
        
        PROTO_FRAME_STAT_ERROR          /* 出现致命错误 */
    }ENUM_WOICE_PROTO_FRAME_STATE;
    ```

5. 下一次待接收的数据长度

    由于Woice一次只接收一帧协议帧，该计数变量配合协议帧接收状态，用于指示下一次从TCP接收缓冲区中请求的数据量。

6. 对端IP地址及类型、端口和其它连接信息

    用于向上层协议或应用提供快速的查询。

7. 本机在当前会话中的角色身份

8. 最后一次KAP时间

    结合本机在当前会话中的角色身份，用于判断是否应当发送KAP或会话持有的连接是否超时。

9. 已注册的各消息通道状态记录表

10. 其它必要项目。

Woice会话对象可提供以下 **方法** （仅提供方法原型示意和说明）：

- **msg_send** (通道，消息地址，消息长度，同步/异步选项，超时时间)

    调用此方法向指定的通道发送消息，会话将为此消息构建协议帧。

    在异步发送时，成功返回协议帧ID（正整数），失败返回错误码（负值）；在同步发送时，成功返回0，失败返回错误码（负值）。

- **msg_cancel** (协议帧ID，超时时间)

    从会话的发送队列撤销一个还未发送成功的协议帧，参见 **4.7 发送撤销** 章节。

    成功返回0，失败返回错误码（负值）。

    > 注：该方法仅在启用对发送撤销的支持后有效。

- **delete** ()

    断开连接并删除当前会话。

    成功返回0，失败返回错误码（负值）。

### 3.3 消息通道相关

消息通道是抽象存在的，因此没有实体，每条通道的状态由结构体数组记录并维护，消息通道的作用、分配和接收回调注册由通道注册表记录，在程序编写时确定。Woice协议层应为每个消息通道保留独立的通道序列号计数和是否启用的开关标志。

消息通道注册示意如下：

```c
typedef struct woice_msg_package
{
    uint32_t msg_len; /* 消息长度 */
    uint8_t *pmsg;   /* 消息内容所在地址 */
}ST_WOICE_MSG_PACKAGE;

typedef struct woice_msg_channel
{
    uint8_t  chn_type;
    uint16_t chn_index;
    uint16_t chn_seq; /* 本地通道当前序列号 */
    bool chn_en;      /* 通道使能标志位 */
    void (*precv_proc)(uint32_t session_id, ST_WOICE_MSG_PACKAGE msg_pack);
}ST_WOICE_MSG_CHANNEL;

static void recv_proc_1_1(uint32_t session_id, ST_WOICE_MSG_PACKAGE msg_pack)
{
    /* 执行消息处理 */
    
    if(msg_pack.pmsg != NULL)
        free(msg_pack.pmsg);
}

ST_WOICE_MSG_CHANNEL woice_msg_channel_list[] = 
{
    {1, 1, 1, true, recv_proc_1_1},
    
    {0, 0, 0, false, NULL} /* 结尾标记，不可更改 */
};
```

<br/>

## 4 协议增强

本章基于 **2 Woice协议** 章所述，提供某些扩展特性的 **实现思路** ，本章描述的内容作为可选支持项可以不被包含在基本的Woice协议设计范围之中。

### 4.1 IPv6支持

Woice协议层设计本身同时支持IPv4和IPv6连接，对于不同的连接方式均提供相同的默认端口（即 **1103** ）。若Woice协议层的实现同时支持IPv4和IPv6连接，则应提供可选择的 **编译** 或 **运行时** 开关，以单独启用或停用对IPv4或IPv6连接的支持。

提供IPv6支持的关键在于TCP服务端和TCP客户端实现，TCP服务端需创建IPv6监听端口，TCP客户端需提供对IPv6地址的连接支持

Woice协议层实现对IPv4和IPv6的支持情况可通过 **信息简报** 体现，由其中 **ipv4_support** 字段和 **ipv6_support** 字段标识，可用于指示已连接的Woice主机能否切换连接方式。

### 4.2 连接口令

连接口令仅对 **Woice从机** 有效，用于在启用指定会话的消息通道前验证连接的合法性。

当Woice主机收到来自Woice从机的信息简报后，校验其 **conn_password** 项若为 **Enabled** 则需在启动消息传输前向对端 **0-2** 内部消息通道传输本次连接所需口令以激活会话。会话激活前，所有传输的协议帧将被丢弃（包括KAP），回应协议帧的消息类型字段被设置为 **MSG_REPLY_UNVERIFIED** 。

连接口令可使用或借鉴已有的身份认证算法，例如RSA，但不应将口令明文传输到对端。有关SSL/TLS协议的内容此处暂略。

:::info 说明

连接口令是Woice协议层对通信身份的验证而非对传输数据本身的保护。由于Woice协议层仅仅是对TCP连接做了抽象，每条消息通道（包括内部消息通道和普通消息通道）中的数据仍然是透传而非经过二次修改，因此如需对消息通道中所传数据进行加密，则该操作应由上层协议或应用完成。

:::

### 4.3 自定义数据校验方式

Woice协议支持修改协议帧中数据校验字段的计算方式，支持的校验方式由实现决定。需在创建Woice协议实例时指定需要使用的校验方式，默认应设置为 **16-bit和校验** 。

注意：通信双方的数据校验方式必须设置为一致方能正常通信，否则消息首部的数据校验失败会导致协议层丢弃整个协议帧！

### 4.4 同步/异步发送

Woice协议的实现可向上层协议或应用提供同步或异步发送接口。

Woice对同步的定义为：调用API向某会话某通道发送协议帧后，等待直到收到对端的消息应答或超时，API调用才返回。

Woice对异步的定义为：调用API向某会话某通道发送协议帧后，API根据该协议帧是否被成功追加到发送队列立即返回对应的结果。当收到对端的消息应答协议帧时，协议层将通过回调通知上层协议或应用。异步方式下，上层协议或应用可能需要为每条发送的消息维持一个计时器以检测对端应答超时的发生（取决于Woice协议层实现是否支持协议帧重传，详见 **4.6 协议帧重传** 章节）。

### 4.5 流量统计报告

Woice协议实现可选择是否开启对某会话 **发送队列状态查询** 及其 **各消息通道的流量统计** 功能，并为该功能提供 **编译** 或 **运行时** 开关。

除了获取会话的流量信息和发送队列状态外，应用程序还可以借助流量统计报告实现对发送数据量的实时控制。当通信对端的处理能力不足导致数据在TCP接收缓冲区堆积时，对端TCP接收窗口将减小，本机发送窗口也将减小，这可能导致本机发送队列阻塞或堆积，从而影响到后续消息的发送。上层协议或应用可以获取Woice协议提供的会话流量变化情况和发送队列状态，并根据这些信息决定是否在未来的一段时间内减少发送数据量。

例如在某视频传输任务中，发送方视频流即将达到对端（或网络）处理能力上限，此时发送方可借助此机制降低所传视频流的分辨率，从而保证推流服务的正常运行。

### 4.6 协议帧重传

Woice协议的实现可选择是否支持协议帧重传，并为该特性提供 **运行时** 开关。当启用协议帧重传时，仅 **校验失败** 和 **回应超时** 的协议帧将被重新传输。

重传的协议帧即原协议帧，其通道序列号和时间戳等字段均保持不变。当协议帧重传次数超出限制时，表示该协议帧发送失败，此时若发送过程为同步发送，则API调用返回失败；若发送过程为异步发送，则协议层将通过内部事件回调通知上层协议或应用。

重传机制需要指定以下配置项：

1. 重传缓冲区大小或重传队列长度；
2. 重传次数；
3. 对端消息回应超时时间。

特别地，协议帧重传机制仅对普通消息通道有效，内部消息通道中的消息（如信息简报和KAP等）不支持重传。该策略被设计用于此目的：在网络连接异常或信道状态差等情况下，KAP相关协议帧被阻塞在发送队列，最终引起会话超时断开。

### 4.7 发送撤销

Woice协议的实现可向上层协议或应用提供发送撤销接口，以支持从发送队列中删除还未发送的协议帧，这可能需要修改发送队列的实现以及发送API的配合。

发送API需要为每条发送的消息提供一个唯一的标识，并将该标识返回给调用者，通过该标识在发送队列中唯一确定一个协议帧。协议帧被撤销后，该协议帧的通道序列号等信息不会被重置或恢复。

在以下情况下，发送撤销将失败：

1. 在发送队列中未找到指定的协议帧。这可能是因为消息已经被发送或提供的消息标识非法；
2. Woice协议栈的具体实现不支持发送撤销接口。

特别地，当协议帧处于重传过程中时，发送撤销将在其执行下一次重传时生效。若本次重传成功，则发送撤销返回等待超时（重试）或失败。

---

————[ **Woice** by **Turix.Space** ]————
