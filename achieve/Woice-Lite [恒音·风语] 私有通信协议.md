---
sidebar_position: 3
slug: woice-lite_v1.x
---

:::note 修订记录

**2022-3-12** 燕卫博[WindForest@yeah.net] 创建V1.x初始版本。

:::

<br/>

:::info 相关信息

Woice-Lite（恒音·风语）协议为 **一种基于TCP的会话层消息传输协议** ，由 **Turix-CEL联合实验室** 设计。

本协议是基于 **Woice V1.x设计原型** 的精简，删除了部分不必要的功能和特性规定，将目标专注在逻辑通道抽象和数据传输上。

当前版本：V1.x 设计原型。仅用于 **原理讨论** 和 **思路开拓**，暂不提供代码实现。

:::

<br/>

:::caution 注意事项

- 设计原型用于原理说明，在具体应用场景下使用时可能需要重新评估或修订。

- 本协议原型 **完全开放** ，您拥有全盘抄袭和任意修改的能力。但是我们仍希望您能够在以下行为中 **任选其一** 以支持创建者的工作：
    1. 与版本创建者取得联系，为其介绍一下即将使用本协议的业务或项目；
    2. 在相关程序和文档中标明出处或引用本网页作为参考；
    3. 在参与者名单中增加版本创建者的名字。

:::

<br/>

## 1 介绍

One connection, then everything. 一条连接，而后万事具备。

<center>

![Woice协议层示意](/img/Woice-Lite协议层示意.png)

</center>

### 1.1 起源与简介

Woice是为低负载和低吞吐量嵌入式设备设计的一种依赖TCP的 **会话层** 消息传输协议。Woice-Lite是在Woice的基础上，为单一连接任务进行精简得到的轻量化版本，在功能和特性上属于Woice的子集，因此在特定的配置下，使用Woice和Woice-Lite的设备具备兼容通信的可能。

Woice-Lite协议为一条TCP连接抽象出多条消息通道，并管理这些通道内数据的传输过程。在Woice-Lite协议之上，用户还需要使用（或设计）基于Woice-Lite的表示层或应用层协议以满足具体的业务需求。本文描述了Woice-Lite协议的协议模型设计、通信角色定义、协议帧规定和其它协议特性。

Woice协议在Loice V1.x设计原型上做出了以下改进：

- 将本机识别信息（如通信双方ID等）从协议字段携带改为基于字符串的信息简报形式；
- Woice可被实现为一种底层库，不直接对接应用层业务；
- Woice中不再区分“指令帧”和“数据帧”，对于Woice协议而言，仅有消息传递的最基本单元即“协议帧”；
- 对于通信双方而言，传输通道是对等的。这意味着在Woice协议层面，一条消息通道中不同方向的数据是相互独立的，然而这一点仍然取决于上层协议的规定。

Woice-Lite协议在Woice V1.x设计原型上做出了以下限制或删减：

- 不支持协议层时间戳，即不鉴定各协议帧的构建顺序
- 不支持手动添加已有的TCP连接到连接管理
- 不支持多连接管理
- 不支持自定义数据校验方式
- 不支持同步发送与应答等待
- 不支持流量统计
- 不支持协议帧自动重传
- 不支持发送撤销

### 1.2 协议限制

Woice-Lite协议具有以下限制：

1. Woice-Lite协议实例可以同时支持主机和从机功能，这将占用指定的TCP监听端口，此时一个设备仅能拥有一个Woice-Lite协议实例。通过关闭主机/从机功能或指定不同的监听端口可使设备运行多个Woice-Lite协议层实例；
2. Woice-Lite协议中，从一条TCP连接中抽象出的传输通道数量是有限的，最大为 **255×65536=16,711,680** 个；
3. Woice-Lite按协议帧发送消息，数据传输的效率主要由网络质量和系统性能决定。

### 1.3 依赖和协议适用

Woice-Lite协议基于TCP传输层协议，依赖TCP的可靠连接和流式传输等特性，理论上只要通信双方能够正常建立TCP连接，就能够使用Woice-Lite协议。考虑到TCP传输依然有出现错误的可能，Woice-Lite在协议帧中增加了必要的校验字段以保证消息的正确性。

Woice-Lite的传输基于无符号字节流，因此通信双方必须事先规定传输时使用的字节序，事实上，只要双方设备使用的架构相同，通常不需要考虑字节序问题。Woice-Lite协议采用 **小端模式** 进行传输，本文也以小端模式进行叙述。

<br/>

## 2 Woice-Lite协议

### 2.1 通信角色和协议模型

在使用Woice-Lite协议的通信系统中，两设备中作为TCP客户端发起连接的一方称为 **Woice-Lite主机** （以下简称 **会话主机** ），作为TCP服务端接受连接的一方称为 **Woice-Lite从机** （以下简称 **会话从机** ）。

一个设备既可以作为会话主机主动发起连接，也可以作为会话从机等待连接，设备可以主动选择是否停用两身份中的一种。通信双方的TCP连接一旦建立，除信息简报交互方向和KAP应答方向根据身份的不同存在差异外，通信过程本身是对等的。

会话从机负责建立TCP服务端，默认绑定在 **1103** 端口，一条TCP连接即一个 **Woice-Lite会话** 。对于一个特定的会话，通信双方的角色是固定的。

### 2.2 协议帧

遵循Woice-Lite协议的一条完整的消息称为一个**协议帧**，每协议帧包含一个定长的消息首部和可变长的消息体。

#### 2.2.1 消息首部

为了在TCP的流式传输中获取一帧完整的协议帧，Woice-Lite协议规定了一个定长的消息首部作为每协议帧的起始，所有传输的消息必须至少包含这个首部，以便对端的识别和处理。

<center>

```
+-----byte 0----|-----byte 1----|-----byte 2----|-----byte 3----+
|7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0|
+---------------+---------------+---------------+---------------+
|                       Head(14-CF-92-5A)                       |
+---------------+---------------+---------------+---------------+
|                       Head(A0-CA-00-FF)                       |
+---------------+---------------+---------------+---------------+
|                 Unused Message Timestamp(00H)                 |
+---------------+---------------+---------------+---------------+
|                 Unused Message Timestamp(00H)                 |
+---------------+---------------+---------------+---------------+
| Message Type  |  Channel Type |        Channel Index          |
+---------------+---------------+---------------+---------------+
|               Payload Length(All Message Body)                |
+---------------+---------------+---------------+---------------+
|    Channel Sequence Number    |  Message Header Check(16-bit) |
+---------------+---------------+---------------+---------------+
```

</center>

Woice-Lite协议消息首部（固定为 **28** 个字节）：

- 使用 **8** 个固定字节（0xFF00CAA05A92CF14）作为 **帧头** ，以便通信双方从连续的字节流中获取到消息的起始位置；
- 保留 **8** 字节长度的 **时间戳** 信息字段用以兼容Woice协议。在Woice-Lite协议中该字段固定为0，若字段非0亦无视该字段；
- 使用 **1** 字节的 **消息类型** 字段用于指示当前协议帧的消息类型。根据消息类型，协议帧可分为 **（普通）协议帧** 和 **内部协议帧** 两种；
- 使用 **1** 字节的 **通道类型** 和 **2** 字节的 **通道索引（通道号）** 字段的组合标识每条抽象出的消息通道，详见 **2.3 消息通道** 章节；
- 使用 **4** 字节的 **荷载长度** 字段用于指示后续消息体的总长度，为接收方接收变长消息体提供申请缓冲区的所需长度信息；
- 使用 **2** 字节长度的 **通道序列号** 供源设备指示当前协议帧在所在消息通道中的 **单向发送** 顺序，同时在回应时起到协议帧标识作用；
- 使用 **2** 字节的 **首部验证** 字段用于确保首部信息的正确性，尤其是其中荷载长度的正确性。

其中，消息类型主要包括发送方相关、接收方相关和心跳包相关3个部分，具体如下（使用C语言枚举定义）：

```c
// ----------------------------------------
// 00000000 b 保留
// 0001XXXX b 消息发送
// 0002XXXX b 消息回应
// 1100XXXX b 协议层KAP
// 其它：保留
// ----------------------------------------
typedef enum message_type
{
    MSG_TYPE_RESERVED       = 0,
    // ----------------------------------------
    // 消息发送
    // ----------------------------------------
    MSG_TYPE_NORMAL         = 0x10, /* 消息需要应答 */
    MSG_TYPE_NOREPLY        = 0x11, /* 消息无需应答 */
    // ----------------------------------------
    // 消息应答
    // ----------------------------------------
    MSG_REPLY_OK            = 0x20, /* 消息被成功接收 */
    // MSG_REPLY_OUTDATE    = 0x21, /* 消息是过时的（Woice-Lite未使用） */
    MSG_REPLY_TOO_LONG      = 0x22, /* 消息超出接收方最大长度限制 */
    MSG_REPLY_TOO_SHORT     = 0x23, /* 消息小于协议最小长度限制 */
    MSG_REPLY_WRONG_CHECK   = 0x24, /* 消息体校验失败 */
    MSG_REPLY_UNREGISTERED  = 0x25, /* 消息所发往的通道未注册 */
    MSG_REPLY_UNVERIFIED    = 0x26, /* 暂未确认连接口令，消息将被丢弃 */
    MSG_REPLY_CHANNEL_PAUSE = 0x27, /* 当前通道暂停接收功能 */
    MSG_REPLY_WRONG_CHANNEL = 0x28, /* 当前消息指定的目标消息通道错误，消息将被丢弃 */
    // ----------------------------------------
    // 心跳包相关
    // NOTE:Woice-Lite协议层对心跳包的回应是强制的
    // ----------------------------------------
    KAP_TYPE_NORMAL         = 0xC3, /* 探测对端是否存在 */
    KAP_REPLY_OK            = 0xC4, /* 协议层KAP存在性回复 */
}ENUM_MESSAGE_TYPE;
```

有关消息应答的说明详见 **2.4 消息应答** 章节；有关心跳包相关的说明详见 **2.6 协议层KAP** 章节。

对于消息首部包含的字段有以下解释或说明：

- 通道序列号范围

    通道序列号字段从 **1** 开始计数，溢出后重新从 **1** 开始，为协议帧重传机制保留。**当通道序列号为0时，表示禁用序列号指示。**通道序列号 **与通信方向相关**，各方独立维护本地通道序列号发送计数。

    有关通道序列号的说明详见 **2.3 消息通道** 章节。

- 荷载长度

    荷载长度字段用于指示在消息首部之后还有多少字节的变长消息。**如当一条消息仅有首部时，荷载长度字段必须设置为0**。

- 消息首部校验

    Woice-Lite使用 **16-bit和校验** 。

#### 2.2.2 消息体

当Woice-Lite协议帧携带有效荷载时，消息体为这些变长数据提供封装。

<center>

```
+-----byte 0----|-----byte 1----|-----byte 2----|-----byte 3----+
|7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0|
+---------------+---------------+---------------+---------------+
|   Message Body Check(16-bit)  |         Reserved(00H)         |
+---------------+---------------+---------------+---------------+
|                    Variable Length Data                       |
|                              ...                              |
+---------------+---------------+---------------+---------------+
```

</center>

消息体拥有独立的 **消息体校验** 字段，Woice-Lite使用 **16-bit和校验** 。

协议帧最小长度为 **4** 字节，最大长度取决于接收端设置（ **≥4字节**）；当协议帧中荷载长度字段设置为 **0** 时，该协议帧无消息体部分。

### 2.3 消息通道

Woice-Lite协议的每个协议帧的消息首部均有 **通道类型** 和 **通道索引** 字段，每个 **通道类型-通道索引** 的组合构成了一条抽象的 **消息传输通道**，一个Woice-Lite会话中的多个消息通道优先级相同，通过共享发送队列复用一条TCP连接。当通信双方在消息通道中传递数据时，分属于各通道协议帧的 **通道序列号** 字段应顺序递增。

Woice-Lite协议将 **0-X** 的消息通道保留为协议内部使用，所有发往这些通道的数据将被协议层内部处理，上层协议或应用程序在基于Woice-Lite协议通信时，无法使用这些消息通道。内部保留通道的预分配和作用如下表所示：

<center>

| 消息通道 |  预分配作用  |        数据传输格式         |
| :------: | :----------: | :-------------------------: |
|   0-0    |   信息简报   | 详见 **2.5 信息简报** 章节  |
|   0-1    |  协议层KAP   | 详见 **2.6 协议层KAP** 章节 |
|   0-2    | 连接口令相关 | 详见 **2.7 连接口令** 章节  |
|   其它   |     保留     |              -              |

</center>

特别地，如果因为协议层错误、传输错误或其它异常导致普通消息通道中出现内部协议帧或内部消息通道中出现普通协议帧的情况，这些协议帧将被丢弃而不向后级逻辑转发，该协议帧的回应中 **消息类型** 字段将被设置为 ``MSG_REPLY_WRONG_CHANNEL`` 。

### 2.4 消息应答

:::caution 注意事项

本章节所述消息应答不适用于协议层内部（即 **0-X** 消息通道）信息交互过程。协议层内部信息交互详见相关章节如 **2.5 信息简报** 和 **2.6 协议层KAP** 等。

:::

消息应答用于向对端报告通信过程中协议帧的接收和校验等情况。应答协议帧仅包含消息首部，没有附加的消息体，表现为首部中的 **荷载长度** 字段为 **0** 。

对于首部消息类型字段为 ``MSG_TYPE_NORMAL`` 的协议帧，消息接收方支持以下回应内容（可同时见于 **2.2.1 消息首部** 章节）；而对于首部消息类型字段为 ``MSG_TYPE_NOREPLY`` 的协议帧，消息接收方不需要向对端发送任何应答（即使该消息的接收出现错误）。

<center>

|          消息应答           |                   应答说明                   |           校验位置           |
| :-------------------------: | :------------------------------------------: | :--------------------------: |
|      ``MSG_REPLY_OK``       |                消息被成功接收                |           ALL PASS           |
|    ``MSG_REPLY_OUTDATE``    |                 消息是过时的                 |          时间戳字段          |
|   ``MSG_REPLY_TOO_LONG``    |          消息超出接收方最大长度限制          |         荷载长度字段         |
|   ``MSG_REPLY_TOO_SHORT``   |     消息小于协议最小长度限制（＜4字节）      |         荷载长度字段         |
|  ``MSG_REPLY_WRONG_CHECK``  |                消息体校验失败                |        消息体校验字段        |
| ``MSG_REPLY_UNREGISTERED``  |            消息所发往的通道未注册            |      通道类型和通道索引      |
|  ``MSG_REPLY_UNVERIFIED``   |        暂未确认连接口令，消息将被丢弃        |       信息简报交互状态       |
| ``MSG_REPLY_CHANNEL_PAUSE`` |     当前通道暂停接收功能，丢弃所有协议帧     |           通道属性           |
| ``MSG_REPLY_WRONG_CHANNEL`` | 当前消息指定的目标消息通道错误，消息将被丢弃 | 消息类型、通道类型和通道索引 |

</center>

在以下情况下，消息接收方将直接丢弃协议帧而不产生回应：

- 消息首部的帧头错误；
- 消息首部校验失败。

此时，消息发送方可通过如上层协议的超时机制、下一协议帧回应的序列号等信息判断是否出现协议帧丢失。

### 2.5 信息简报

信息简报用于向通信对方提供本机设备必要的描述信息，以供双方识别和记录等之用。

当通信双方的TCP连接建立后，**会话主机** 首先从 **0-0** 内部消息通道向对端发送自己的信息简报，**会话从机** 收到来自消息主机的消息简报后，立即回复应答报文，然后构建并发送己方信息简报。在通信畅通的情况下，双方信息简报的交互仅进行 **1** 次，交互完成前双方 **暂停KAP协议帧收发** 且消息通道保持 **暂停接收** 状态。

特别地，若信息简报协议帧出现错误，则检测到错误的一方应主动关闭连接；若一方未收到对方的信息简报协议帧，KAP超时机制会关闭此会话。

信息简报的具体内容以 **字符串** 形式随消息体发送，包含以下部分：

1. 本机设备信息；
2. 当前Woice-Lite协议层版本和限制信息；
3. 当前会话信息。

信息简报按行组织，每行格式如下所示。冒号“:”被用于各项与值之间的划分。

```
项:字符串
item_1:string_1
item_2:string_2
...
```

信息简报中各项定义如下，根据通信方身份的不同，它们中的某些不是必须的。其中的固定项需保留用以兼容Woice协议，“?”项表示可根据需要进行选择。

<center>

|      项       |             值              | 固定值 |                           说明                           |
| :-----------: | :-------------------------: | :----: | :------------------------------------------------------: |
|      id       | e.g. "BC4699-BBFEC5-1-1213" |        |          可用于自定义的设备ID或其它程序标识信息          |
| woice_version |         "V1.x Lite"         |   是   |           提供woice版本和实现信息供兼容或适配            |
| session_role  |     "master" or "slave"     |        |                 当前会话在该连接中的角色                 |
|  max_session  |             "1"             |   是   |                 当前程序支持的最大会话数                 |
| exist_session |             "1"             |   是   |              当前已存在的会话数（包含自身）              |
|    status     |      "ok"、"disabled"       |        |     用于指示当前程序/设备是否使能通信或做好通信准备      |
| ipv4_support  |         "yes"、"no"         |   ?    |          用于指示当前程序/设备是否支持IPv4连接           |
| ipv6_support  |         "yes"、"no"         |   ?    |          用于指示当前程序/设备是否支持IPv6连接           |
| conn_password |    "enabled"、"disabled"    |        | 用于指示当前连接是否需要口令，详见 **2.7 连接口令** 章节 |
|      ...      |             ...             |        |                           ...                            |

</center>

以下为通信双方发送信息简报内容的示例：

- 会话主机

    ```
    id:BC4699-BBFEC5-1-1213-2
    woice_version:V1.0 Test
    session_role:master
    ```

- 会话从机

    ```
    id:BC4699-BBFEC5-1-1213-1
    woice_version:V1.0 Beta
    session_role:slave
    max_session:1
    exist_session:1
    status:ok
    ipv4_support:yes
    ipv6_support:no
    conn_password:disabled
    ```

在以下情况发生时，会话将在 **完成信息简报交互后** 被Woice-Lite（主机或从机方的）协议层主动关闭，此时信息简报将提供关闭的原因：

1. 不支持通信对端的Woice-Lite版本；
2. 通信对端的会话角色不正确；
3. 当前会话从机因故未做好消息处理准备；
4. 连接口令错误（详见 **2.7 连接口令** 章节）；
5. 信息简报项目缺失。

### 2.6 协议层KAP

考虑到TCP在长连接时无法获得对端存活状态，Woice-Lite定义了协议层KAP消息（以下简称KAP）。KAP仅包含消息首部，没有附加的消息体，表现为首部中 **荷载长度** 字段为 **0** 。KAP使用 **0-1** 内部保留的消息通道。

对于一个已经建立并完成身份验证（详见 **2.7 连接口令** 章节）的Woice-Lite会话，KAP总是由 **会话主机** 定时发起，由 **会话从机** 应答，KAP消息的往复过程即会话的心跳。当收到来自 **会话主机** 首部消息类型字段为 ``KAP_TYPE_NORMAL`` 的协议帧时，**会话从机** 在校验其正确性后构建并发送首部消息类型字段为 ``KAP_REPLY_OK`` 的KAP应答。

Woice-Lite通信双方对KAP的处理策略如下：

<center>

|          项           |                             说明                             |
| :-------------------: | :----------------------------------------------------------: |
| 会话主机的KAP发送策略 | 一定时间范围内，本机未发送包括普通消息应答在内的任何协议帧到 **会话从机**，则立即构建并发送一帧KAP |
| 会话主机的KAP超时策略 | 一定时间范围内，本机未从 **会话从机** 收到包括KAP在内的任何协议帧的回应，则应立即关闭会话 |
| 会话从机的KAP处理策略 | 当收到来自 **会话主机** 的KAP时，构建对应的回应协议帧并追加到发送队列 |
| 会话从机的KAP超时策略 | 一定时间范围内，本机未从 **会话主机** 收到包括KAP在内的任何 **有效** 协议帧 |

</center>

在以下情况下，**会话从机** 将直接丢弃该KAP而不产生回应：

- 消息首部的帧头错误；
- 消息首部校验失败。

上述策略中，消息通道中传输的数据在一定程度上充当了KAP，这是为了在双方有大量数据传输时节约带宽和处理器资源。当网络质量较差导致消息通道中的数据在发送方持续堆积时，KAP机制将使得协议层主动断开连接。

### 2.7 连接口令

连接口令仅对 **会话从机** 有效，用于在启用某会话的消息通道前验证连接的合法性。

当会话主机收到来自会话从机的信息简报后，校验其 **conn_password** 项若为 **enabled** 则需在启动消息传输前向对端 **0-2** 内部消息通道传输本次连接所需口令以激活会话。会话激活前，所有传输的协议帧将被丢弃（包括KAP），回应协议帧的消息类型字段被设置为 ``MSG_REPLY_UNVERIFIED`` 。

连接口令可使用或借鉴已有的身份认证算法，例如RSA，但不应将口令明文传输到对端。有关SSL/TLS协议的内容此处暂略。

:::info 说明

连接口令是Woice-Lite协议层对通信身份的验证而非对传输数据本身的保护。由于Woice-Lite协议层仅仅是对TCP连接做了抽象，每条消息通道（包括内部消息通道和普通消息通道）中的数据仍然是透传而非经过二次修改，因此如需对消息通道中所传数据进行加密，则该操作应由上层协议或应用完成。

:::

---

————[ **Woice-Lite** by **Turix.Space** ]————
